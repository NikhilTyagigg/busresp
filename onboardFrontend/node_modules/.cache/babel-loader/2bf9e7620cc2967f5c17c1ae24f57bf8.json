{"ast":null,"code":"import t, { Fragment as n, createElement as r, Children as i, PureComponent as u } from \"react\";\nfunction e(t, n) {\n  for (var r = 0; r < n.length; r++) {\n    var i = n[r];\n    i.enumerable = i.enumerable || false;\n    i.configurable = true;\n    if (\"value\" in i) i.writable = true;\n    Object.defineProperty(t, i.key, i);\n  }\n}\nfunction o(t, n, r) {\n  if (n) e(t.prototype, n);\n  if (r) e(t, r);\n  return t;\n}\nfunction f() {\n  f = Object.assign || function (t) {\n    for (var n = 1; n < arguments.length; n++) {\n      var r = arguments[n];\n      for (var i in r) if (Object.prototype.hasOwnProperty.call(r, i)) t[i] = r[i];\n    }\n    return t;\n  };\n  return f.apply(this, arguments);\n}\nfunction c(t, n) {\n  t.prototype = Object.create(n.prototype);\n  t.prototype.constructor = t;\n  a(t, n);\n}\nfunction a(t, n) {\n  a = Object.setPrototypeOf || function t(n, r) {\n    n.__proto__ = r;\n    return n;\n  };\n  return a(t, n);\n}\nvar s = function t() {};\nvar h = n ? function (t) {\n  if (!t) return null;\n  return t.length > 1 ? r.apply(void 0, [n, null].concat(t)) : i.only(t);\n} : i.only;\nvar l = function (t) {\n  c(n, t);\n  function n() {\n    var n;\n    for (var r = arguments.length, i = new Array(r), u = 0; u < r; u++) i[u] = arguments[u];\n    n = t.call.apply(t, [this].concat(i)) || this;\n    n.t = false;\n    n.i = null;\n    n.u = s;\n    return n;\n  }\n  var r = n.prototype;\n  r.componentWillUnmount = function t() {\n    this.u();\n  };\n  r.o = function _connectToAbility(t) {\n    var n = this;\n    if (t === this.i) return;\n    this.u();\n    this.i = null;\n    if (t) {\n      this.i = t;\n      this.u = t.on(\"updated\", function () {\n        return n.forceUpdate();\n      });\n    }\n  };\n  r.h = function t() {\n    var n = this.props;\n    var r = n.of || n.a || n.an || n.this || n.on;\n    var i = n.not ? \"cannot\" : \"can\";\n    return n.ability[i](n.I || n.do, r, n.field);\n  };\n  r.render = function t() {\n    this.o(this.props.ability);\n    this.t = this.h();\n    return this.props.passThrough || this.t ? this.l() : null;\n  };\n  r.l = function t() {\n    var n = this.props,\n      r = n.children,\n      i = n.ability;\n    var u = \"function\" === typeof r ? r(this.t, i) : r;\n    return h(u);\n  };\n  o(n, [{\n    key: \"allowed\",\n    get: function t() {\n      return this.t;\n    }\n  }]);\n  return n;\n}(u);\nfunction v(t) {\n  var n, r;\n  return r = n = function (t) {\n    c(n, t);\n    function n() {\n      return t.apply(this, arguments) || this;\n    }\n    return n;\n  }(l), n.defaultProps = {\n    ability: t\n  }, r;\n}\nfunction b(t) {\n  return function (n) {\n    return r(t, null, function (t) {\n      return r(l, f({\n        ability: t\n      }, n));\n    });\n  };\n}\nfunction useAbility(n) {\n  if (\"production\" !== process.env.NODE_ENV && \"function\" !== typeof t.useContext) throw new Error(\"You must use React >= 16.8 in order to use useAbility()\");\n  var r = t.useContext(n);\n  var i = t.useState(),\n    u = i[0],\n    e = i[1];\n  t.useEffect(function () {\n    return r.on(\"updated\", function (t) {\n      if (t.rules !== u) e(t.rules);\n    });\n  }, []);\n  return r;\n}\nexport { l as Can, v as createCanBoundTo, b as createContextualCan, useAbility };","map":{"version":3,"sources":["../../src/Can.ts","../../src/factory.ts","../../src/hooks/useAbility.ts"],"names":["noop","renderChildren","Fragment","children","length","createElement","Children","only","Can","PureComponent","_isAllowed","_ability","_unsubscribeFromAbility","componentWillUnmount","_connectToAbility","ability","this","on","_this2","forceUpdate","_canRender","props","subject","of","a","an","can","not","I","do","field","render","passThrough","_renderChildren","elements","createCanBoundTo","defaultProps","createContextualCan","Getter","h","useAbility","context","process","env","NODE_ENV","React","useContext","Error","rules","setRules","useState","useEffect","event"],"mappings":"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","sourcesContent":["import { Children, ReactNodeArray, PureComponent, Fragment, createElement } from 'react';\nimport {\n  Unsubscribe,\n  AbilityTuple,\n  SubjectType,\n  AnyAbility,\n  Generics,\n  Abilities,\n  IfString,\n} from '@casl/ability';\n\nconst noop = () => {};\nconst renderChildren = Fragment\n  ? (children?: ReactNodeArray) => {\n    if (!children) {\n      return null;\n    }\n\n    return children.length > 1\n      ? createElement(Fragment, null, ...children)\n      : Children.only(children);\n  }\n  : Children.only;\n\ntype AbilityCanProps<\n  T extends Abilities,\n  Else = IfString<T, { do: T } | { I: T }>\n> = T extends AbilityTuple\n  ? { do: T[0], on: T[1], field?: string } |\n  { I: T[0], a: Extract<T[1], SubjectType>, field?: string } |\n  { I: T[0], an: Extract<T[1], SubjectType>, field?: string } |\n  { I: T[0], this: Exclude<T[1], SubjectType>, field?: string }\n  : Else;\n\ninterface ExtraProps {\n  not?: boolean\n  passThrough?: boolean\n}\n\ninterface CanExtraProps<T extends AnyAbility> extends ExtraProps {\n  ability: T\n}\n\ninterface BoundCanExtraProps<T extends AnyAbility> extends ExtraProps {\n  ability?: T\n}\n\nexport type CanProps<T extends AnyAbility> =\n  AbilityCanProps<Generics<T>['abilities']> & CanExtraProps<T>;\nexport type BoundCanProps<T extends AnyAbility> =\n  AbilityCanProps<Generics<T>['abilities']> & BoundCanExtraProps<T>;\n\nexport class Can<\n  T extends AnyAbility,\n  IsBound extends boolean = false\n> extends PureComponent<IsBound extends true ? BoundCanProps<T> : CanProps<T>> {\n  private _isAllowed: boolean = false;\n  private _ability: T | null = null;\n  private _unsubscribeFromAbility: Unsubscribe = noop;\n\n  componentWillUnmount() {\n    this._unsubscribeFromAbility();\n  }\n\n  private _connectToAbility(ability?: T) {\n    if (ability === this._ability) {\n      return;\n    }\n\n    this._unsubscribeFromAbility();\n    this._ability = null;\n\n    if (ability) {\n      this._ability = ability;\n      this._unsubscribeFromAbility = ability.on('updated', () => this.forceUpdate());\n    }\n  }\n\n  get allowed() {\n    return this._isAllowed;\n  }\n\n  private _canRender(): boolean {\n    const props: any = this.props;\n    const subject = props.of || props.a || props.an || props.this || props.on;\n    const can = props.not ? 'cannot' : 'can';\n\n    return props.ability[can](props.I || props.do, subject, props.field);\n  }\n\n  render() {\n    this._connectToAbility(this.props.ability);\n    this._isAllowed = this._canRender();\n    return this.props.passThrough || this._isAllowed ? this._renderChildren() : null;\n  }\n\n  private _renderChildren() {\n    const { children, ability } = this.props;\n    const elements = typeof children === 'function'\n      ? children(this._isAllowed, ability)\n      : children;\n\n    return renderChildren(elements);\n  }\n}\n","import { createElement as h, ComponentClass, Consumer, StatelessComponent } from 'react';\nimport { AnyAbility } from '@casl/ability';\nimport { Can, BoundCanProps } from './Can';\n\ninterface BoundCanClass<T extends AnyAbility> extends ComponentClass<BoundCanProps<T>> {\n  new (props: BoundCanProps<T>, context?: any): Can<T, true>\n}\n\nexport function createCanBoundTo<T extends AnyAbility>(ability: T): BoundCanClass<T> {\n  return class extends Can<T, true> {\n    static defaultProps = { ability } as BoundCanClass<T>['defaultProps'];\n  };\n}\n\nexport function createContextualCan<T extends AnyAbility>(\n  Getter: Consumer<T>\n): StatelessComponent<BoundCanProps<T>> {\n  return (props: BoundCanProps<T>) => h(Getter, null, (ability: T) => h(Can, {\n    ability,\n    ...props,\n  } as any));\n}\n","import React from 'react';\nimport { AnyAbility } from '@casl/ability';\n\nexport function useAbility<T extends AnyAbility>(context: React.Context<T>): T {\n  if (process.env.NODE_ENV !== 'production' && typeof React.useContext !== 'function') {\n    /* istanbul ignore next */\n    throw new Error('You must use React >= 16.8 in order to use useAbility()');\n  }\n\n  const ability = React.useContext<T>(context);\n  const [rules, setRules] = React.useState<T['rules']>();\n\n  React.useEffect(() => ability.on('updated', (event) => {\n    if (event.rules !== rules) {\n      setRules(event.rules);\n    }\n  }), []);\n\n  return ability;\n}\n"]},"metadata":{},"sourceType":"module"}